# Dockerfile for interuss/geospatial-utils
#
# The image generated by this Dockerfile (via ./build.sh) includes the entire
# `geospatial-utils` folder contents in /app/geospatial-utils and has installed dependencies
# necessary to run any of the geospatial-utils tools.
#
# This image is intended to be built from the repository root context/folder.

FROM ghcr.io/astral-sh/uv:python3.13-bookworm-slim
# Not -alpine because: https://stackoverflow.com/a/58028091/651139

# Install system tools
#   openssl: Provides TLS tools
#   curl: Useful debugging utility
#   gcc: Required to build various packages
#   ca-certificates: Needed to accurately validate TLS connections
RUN apt-get update --fix-missing && apt-get install -y make openssl curl libgeos-dev gcc g++ && apt-get install ca-certificates

# Required to build in an ARM environment
#   gevent: libffi-dev libssl-dev python3-dev build-essential
#   lxml: libxml2-dev libxslt-dev
#   h5py: pkg-config libhdf5-dev
RUN if [ "$(uname -m)" = "aarch64" ]; then \
    apt-get install -y libffi-dev libssl-dev python3-dev build-essential libxml2-dev libxslt-dev pkg-config libhdf5-dev \
; fi

RUN mkdir -p /app/

# Install dependencies
ENV UV_LINK_MODE=copy
ENV UV_PROJECT_ENVIRONMENT=/venv/
ENV VIRTUAL_ENV=/venv/
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=./uv.lock,target=/app/uv.lock \
    --mount=type=bind,source=./pyproject.toml,target=/app/pyproject.toml \
    cd /app && \
    uv sync --locked --no-install-project --compile-bytecode

# Ensure UV don't check dependencies or lock file, since we installed everything before
ENV UV_FROZEN=1

# Ensure the cache folder is present and writable by anyone
# (Some command run with limited privileges)
RUN mkdir -p /.cache/uv/ && chmod 777 /.cache/uv/
# Also fix the root folder where python is downloaded
RUN find /root/ -type d -exec chmod a+rx {} +

# Start in this folder
WORKDIR /app/geospatial-utils

# Add core content from repo
ADD ./geospatial-utils /app/geospatial-utils

# Discover `geospatial-utils` module in Python
ENV PYTHONPATH=/app

# Add venv to path
ENV PATH="/venv/bin/:$PATH"

# This image should be built by passing in `version` and `commit_hash` based on information from git (see `make image`)
# This version information becomes available in the environment variables specified below
ARG version
ARG commit_hash
ENV GEOSPATIAL_UTILS_VERSION=$version
ENV GIT_COMMIT_HASH=$commit_hash

# No entry point maximizes flexibility in the use of this image
ENTRYPOINT []